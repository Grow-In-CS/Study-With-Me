# CORS란
CORS (교차 출처 리소스 공유) 는 웹 브라우저가 다른 출처(origin) 의 리소스에 접근할 수 있도록 허용하는 메커니즘이다.

여기서 출처(origin) 는 아래 요소로 구성된다. : 프로토콜 + 도메인 + 포트

ex)
주소	출처
```text
https://example.com:443
https://example.com:443
http://example.com:80
```
위 세 주소는 모두 다른 출처다.

기본적으로 브라우저는 보안상의 이유로 다른 출처 간 요청을 제한한다.
이를 Same-Origin Policy(동일 출처 정책) 이라고 합니다.

# CORS 가 필요한 이유
만약 CORS 제약이 없다면, 악성 사이트에서 사용자의 브라우저를 이용해 임의로 API 요청을 보내 개인정보를 탈취할 수도 있다.

하지만 현대 웹은 SPA 구조로, 프론트엔드 서버(localhost:3000)와 백엔드 서버(localhost:8080)가 분리되어 있는 경우가 많다.
이 경우 두 서버의 출처가 다르기 때문에, 브라우저는 기본적으로 요청을 차단한다.

그래서 CORS 정책을 통해 "이 출처는 허용할게요" 라고 명시적으로 서버가 브라우저에 알려줘야 한다.

# CORS 동작 원리
### 1. Simple Request

단순 요청으로, 특정 조건을 만족할 때는 사전 요청(Preflight) 없이 바로 서버로 전송된다.

 - 조건:
   - 메서드: GET, POST, HEAD
   - 헤더: Accept, Content-Type (단, 값은 text/plain, multipart/form-data, application/x-www-form-urlencoded 중 하나)
   - XMLHttpRequest 또는 fetch 사용 시 withCredentials가 false일 것
 - 동작:
   1. 브라우저가 바로 요청을 보냄.
   2. 서버가 응답 헤더에 아래 항목을 포함.
   3. Access-Control-Allow-Origin: https://myfrontend.com
   4. 브라우저가 허용된 출처인지 확인 후 응답 허용.

### 2. Preflight Request
조건을 만족하지 않으면, 브라우저는 OPTIONS 메서드로 사전 요청을 보낸다.

 - 동작 순서
   1. 브라우저가 OPTIONS 요청 전송
   ```text
   OPTIONS /api/user
   Origin: https://myfrontend.com
   Access-Control-Request-Method: POST
   Access-Control-Request-Headers: Content-Type
   ```
   2. 서버가 허용 정보를 응답
   ```text
   Access-Control-Allow-Origin: https://myfrontend.com
   Access-Control-Allow-Methods: POST
   Access-Control-Allow-Headers: Content-Type
   ```
   3. 브라우저가 이를 확인 후 실제 요청을 보냄
### 3. Credentialed Request
쿠키나 인증 정보를 포함하는 요청
```text
fetch("https://api.example.com/data", {
  credentials: "include",
});
fetch("https://api.example.com/data", {
  credentials: "include",
});
```
이 경우 서버는 반드시 아래 설정을 해야한다.
```text
Access-Control-Allow-Origin: https://myfrontend.com   // * 사용 불가
Access-Control-Allow-Credentials: true
```

# CORS 에러 예시
프론트엔드(localhost:3000)에서 아래와 같이 API 요청을 보냈다고 가정한다.
```javascript
fetch("http://localhost:8080/api/data")
  .then(res => res.json())
  .then(console.log);
```
이때 만약 서버에 아무 설정도 없다면 아래와 같은 에러가 발생한다.
```text
Access to fetch at 'http://localhost:8080/api/data'
from origin 'http://localhost:3000' has been blocked by CORS policy:
No 'Access-Control-Allow-Origin' header is present on the requested resource.
```

브라우저가 서버 응답에
Access-Control-Allow-Origin 헤더를 찾지 못했기 때문에 요청을 차단한 것이다.

# 해결 방법
spring 의 경우
```java
@Configuration
public class WebConfig implements WebMvcConfigurer {
    @Override
    public void addCorsMappings(CorsRegistry registry) {
        registry.addMapping("/api/**")
                .allowedOrigins("http://localhost:3000")
                .allowedMethods("GET", "POST", "PUT", "DELETE")
                .allowCredentials(true);
    }
}
```

nginx의 경우
```text
location /api/ {
    add_header 'Access-Control-Allow-Origin' 'http://localhost:3000' always;
    add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS, PUT, DELETE';
    add_header 'Access-Control-Allow-Headers' 'Origin, Content-Type, Accept, Authorization';
    if ($request_method = 'OPTIONS') {
        return 204;
    }
}
```