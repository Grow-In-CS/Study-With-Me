# CSRF & XSS

## **교차 사이트 요청 위조**(Cross-Site Request Forgery, CSRF)

### CSRF란?

**교차 사이트 요청 위조**(Cross-Site Request Forgery, CSRF)는 **신뢰할 수 있는 사용자를 사칭해 웹 사이트에 원하지 않는 명령을 보내는 공격**입니다.

사용자가 뜻하지 않게 자격 증명을 사용하여 계정에서 자금을 이체하거나 이메일 주소 및 비밀번호를 변경하거나 기타 원치 않는 작업을 수행하는 등 상태 변경 활동을 호출하도록 속입니다.

<br/>

### 작동 원리

CSRF의 핵심 원리는 **피해자가 로그인 상태인 웹사이트에, 공격자가 악의적인 요청을 전송하도록 유도**하는 데 있습니다.

1. **사용자 로그인 상태**

   사용자는 예를 들어 은행이나 쇼핑몰 같은 웹사이트에 정상적으로 로그인합니다.
   브라우저에는 세션 쿠키 등 인증 정보가 저장되어 있습니다.

2. **악성 사이트 방문**

   동일 브라우저에서 사용자가 공격자가 만든 악성 웹사이트나 링크(이메일, 게시글 등)를 클릭합니다.

3. **위조된 요청 자동 전송**

   공격자의 사이트에는 피해자가 로그인한 사이트로 데이터 변경이나 송금 등 위험한 요청을 자동 전송하는 스크립트가 작성돼 있습니다.

   이때 브라우저는 원래 사이트에 로그인되어 있어 세션 쿠키를 자동으로 첨부합니다.

4. **서버에서는 정상 요청으로 처리**

   서버는 쿠키가 있으니 이 사용자가 직접 요청한 것으로 인식하고, 요청을 실제로 수행합니다.

5. **피해자는 아무것도 모름**

   피해자는 본인이 원치 않는 작업(계정 설정 변경, 금전 이체 등)이 자기 계정에서 실제로 일어났음을 뒤늦게 알게 됩니다.

<br/>

### 프론트엔드에서 CSRF **방지 보안 조치**

CSRF 공격을 프론트엔드 단에서 예방하기 위해서는 다음과 같은 조치들을 취할 수 있습니다.

**1. CSRF 토큰 포함**

**요청 시 서버에서 발급받은 CSRF 토큰을 반드시 함께 전송**하세요.

- 주로 **`x-csrf-token`** 같은 헤더에 포함해 요청합니다.
- 토큰이 없는 요청은 서버에서 거부하게 만듭니다.
- HTML 폼 전송 시 hidden 필드나, Ajax 요청 시 헤더에 포함시키는 것이 일반적입니다.

**2. SameSite 쿠키 옵션 설정**

브라우저가 **쿠키를 동일한 사이트에서만 전송**하도록 만들어, 외부 사이트에서 자동으로 쿠키가 첨부되지 않게 합니다.

- **`SameSite=Strict`** : 가장 강력, 완전히 동일한 도메인 간에만 쿠키를 전송합니다.
- **`SameSite=Lax`** : 일반적인 링크/GET요청에는 허용, POST 등 주요 작업에는 차단.

이 옵션은 서버에서 쿠키를 내려줄 때도 지정하지만, 프론트엔드에서 CSRF 방어를 확인·테스트할 때 체크해볼 수 있습니다.

**3. API 요청 시 수동 토큰 포함 (토큰 기반 인증)**

클라이언트 단에서 **로컬 스토리지 등에 저장한 토큰(JWT 등)을 요청 헤더에 명시적으로 실어 보내기**

- 자동으로 쿠키가 첨부되는 것이 아니므로, CSRF 위험이 비교적 낮습니다.

**4. Referer/Origin 헤더 체크 (부수적)**

필요하다면 요청이 신뢰할 수 있는 사이트에서 왔는지 확인할 수 있습니다.

다만, Referer는 프록시 등 중간 과정에서 빠질 수 있어 보조 수단으로만 사용합니다.

**5. 중요한 작업엔 추가 인증(예: reCAPTCHA)**

송금, 비밀번호 변경 등 매우 민감한 작업에서는 **추가로 reCAPTCHA 같은 인증**을 넣어 사람만 요청 가능하게 할 수 있습니다.

<br/>

## XSS(Cross Site Scripting)

### XSS란?

XSS(Cross Site Scripting)는 웹 서버 사용자에 대한 입력값 검증이 미흡할 때 발생하는 취약점으로, 주로 여러 사용자가 보는 게시판이나 메일 등을 통해 악성 스크립트를 삽입하는 공격 기법입니다.

일반적으로 사용자 쿠키/세션 값 탈취, 키보드 입력값 탈취 등이 가능하며, 피싱 사이트와 같은 악성 사이트로의 접근 유도가 가능해 사용자에게 직접적인 피해를 줄 수 있습니다.

<br/>

### 공격 유형

크로스 사이트 스크립트 공격은 주로 스크립트 언어와 취약한 코드를 대상으로 하며, 공격 방법에 따라 크게 3가지 유형으로 구분할 수 있습니다.

1. **Stored XSS (저장형 크로스사이트스크립트)**

   취약점이 있는 웹 서버에 악성 스크립트를 저장하는 공격 방법입니다.

   공격자는 악성 스크립트가 포함된 게시글을 작성하여 게시판 등 사용자가 접근할 수 있는 페이지에 업로드 합니다.

   이후 사용자가 해당 게시글을 요청하면 서버에 저장된 악성 스크립트가 사용자 측에서 동작하게 됩니다.

1. **Reflected XSS (반사형 크로스사이트스크립트)**

   웹 응용 프로그램의 지정된 변수를 이용할 때 발생하는 취약점을 이용하는 공격으로, 악성 스크립트가 데이터베이스와 같은 저장소에 별도로 저장되지 않고 사용자의 화면에 즉시 출력됩니다.

   주로 이메일, 메신저 등에 포함된 URL을 통해 공격이 이루어지고 있습니다.

1. **DOM Based XSS (DOM 기반 크로스사이트스크립트)**

   악성 스크립트가 서버와 상호작용 없이 브라우저 자체에서 실행되는 취약점으로, 페이지에 포함되어 있는 브라우저 악성코드가 DOM 환경에서 실행됩니다.

<br/>

### 프론트엔드에서 XSS **방지 보안 조치**

XSS(교차 사이트 스크립팅) 방어는 사용자 데이터를 다루는 모든 과정에서 신경써야 할 보안 작업입니다.

아래와 같은 방식들을 조합하면 대부분의 XSS 공격을 효과적으로 예방할 수 있습니다.

**1. 특수문자 이스케이프 처리**

사용자 입력에서 **`<`**, **`>`**, **`"`**, **`'`**, **`&`** 등 HTML 태그나 자바스크립트로 해석되는 특수문자를 **HTML 엔티티**로 변환해 출력합니다.

- 예: **`<`** → **`&lt;`**, **`>`** → **`&gt;`**.

입력값을 바로 DOM에 넣는 대신, 항상 이스케이프 처리한 뒤 렌더링합니다.

**2. 입력값 검증(Validation)**

허용된 데이터만 받고, 문자열 길이·패턴(정규식 등)을 제한합니다.

꼭 필요한 문자 외에는 입력이 불가능하도록 제한해 위험한 스크립트 삽입을 막을 수 있습니다.

**3. 외부 라이브러리 활용**

DOMPurify 같은 **XSS 방지 라이브러리**를 활용해 사용자 입력 내의 악성 코드나 이벤트 핸들러를 자동으로 제거할 수 있습니다.

**4. dangerouslySetInnerHTML, v-html 등 직접 DOM 삽입 기능 주의**

React의 **`dangerouslySetInnerHTML`**, Vue의 **`v-html`**처럼 사용자가 입력한 HTML을 "있는 그대로" 렌더링하는 기능은 꼭 필요한 경우에만 사용하고, 항상 입력값을 정제합니다.

**5. CSP(콘텐츠 보안 정책) 설정**

CSP(Content Security Policy)를 적용해 외부 스크립트, 인라인 자바스크립트 실행을 제한할 수 있습니다.

헤더 또는 meta 태그로 정책을 추가하면, 의도치 않은 리소스 로딩·실행을 막아줍니다.

**6. 쿠키의 HTTPOnly 옵션 활용(보조)**

쿠키 자체를 JS에서 읽지 못하게 **`HTTPOnly`**로 설정하면 세션 탈취 위험을 줄일 수 있습니다.

<br/>
<br/>

> 참고
>
> - https://www.cloudflare.com/ko-kr/learning/security/threats/cross-site-request-forgery/
> - https://www.fortinet.com/kr/resources/cyberglossary/csrf
> - https://www.yolog.co.kr/post/security-csrf
> - https://www.skshieldus.com/blog-security/security-trend-idx-06
> - https://ltr2006.tistory.com/10
> - https://developers.hyundaimotorgroup.com/blog/439
> - https://soeun2537.tistory.com/27
