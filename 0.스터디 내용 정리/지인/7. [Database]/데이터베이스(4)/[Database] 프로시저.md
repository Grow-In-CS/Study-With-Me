# 프로시저

## 프로시저란?

프로시저란 컴퓨터 프로그래밍에서 특정 작업을 수행하기 위해 일련의 명령어들을 모아놓은 것을 말합니다.

명령어 집합을 하나의 메서드 형식으로 만들고 어떤 동작을 일괄적으로 처리하는 용도로 쓰입니다.

만약 여러 개의 칼럼을 조회하거나 여러 개의 테이블을 조회하려고 할 때, 이것을 하나의 쿼리문으로 만들면 복잡하고 긴 쿼리문이 생성됩니다.

따라서 여러 개의 쿼리를 한 번에 사용할 때 이를 프로시저에 저장하여 호출합니다.

---

<br/>

이러한 프로시저는 “DB 서버 안에 저장된 실행 단위”입니다.

애플리케이션에서 여러 SQL을 왔다 갔다 시키지 않고, 미리 정의해 둔 작업 묶음을 한 번의 호출로 실행합니다.

이러한 특성에서 장점과 단점의 파생됩니다.

<br/>

### 프로시저의 장점

- 성능
  앱이 DB에 여러 번 왔다 갔다 할 필요 없이 프로시저 한 번으로 처리합니다.
  따라서 전체 시간이 줄어드는 경우가 많습니다.
- 일관된 실행 계획
  많은 DBMS가 프로시저 실행 계획을 캐시/컴파일해 재사용하므로 반복 호출에서 성능 변동이 적고 예측 가능성이 올라갑니다.
- 트랜잭션 경계 내 정합성 보장
  여러 단계를 하나의 트랜잭션으로 묶어 원자적으로 커밋/롤백 가능해, 데이터 무결성을 강하게 보장할 수 있습니다.
- 배포 탄력성
  일부 변경은 애플리케이션 재배포 없이 프로시저만 갱신해 반영할 수 있어 긴급 패치에 유리할 때가 있습니다.

### 프로시저의 단점

- 이식성 저하
  DBMS별 문법/내장 패키지가 달라 재사용 및 마이그레이션이 어렵습니다.
- 테스트/디버깅/리팩토링 난이도
  일반 앱 코드 대비 도구와 생태계가 빈약한 경우가 많아 개발 및 테스트가 어려운 경우가 많습니다.
- 가시성/형상관리 취약
  프로시저를 깃/리뷰/자동 배포에 제대로 묶어두지 않으면 DB 안에 박힌 코드가 되어, 누가 무엇을 바꿨는지 팀에서 보기 어려워집니다.
- 보안 리스크
  동적 SQL을 부주의하게 사용하면 SQL 인젝션 표면이 넓어집니다.
  반드시 매개변수 바인딩·화이트리스트·권한 최소화를 적용해야 합니다.

<br/>

## 프로시저와 함수의 차이점

전통적 의미에서 프로시저는 부수효과를 내는 서브루틴, 함수는 값을 계산해 돌려주는 서브루틴을 의미합니다.

그러나 대부분의 범용 언어가 이 구분을 문법적으로 강제하지는 않습니다.

언어와 런타임, DBMS가 어떻게 규정했는지가 실제 차이를 만든다고 볼 수 있습니다.

Oracle, SQL Server 같은 DBMS는 ‘저장 프로시저’와 ‘함수’를 아예 다른 엔티티로 나눕니다.

프로시저는 `CALL/EXEC` 로만 호출되고 표현식 자리에서는 사용할 수 없으면, 대신 트랜잭션 제어나 폭넓은 DML을 허용합니다.

함수는 반드시 값을 반환하고 `SELECT` 등 표현식 안에서 쓸 수 있지만, 그 대가로 부수효과가 제한되거나 금지됩니다.

### Oracle 예제

Oracle에서 함수와 프로시저를 사용하는 예제를 통해 둘의 차이를 확인해보겠습니다.

```sql
CREATE TABLE orders (
  id        NUMBER PRIMARY KEY,
  amount    NUMBER(12,2) NOT NULL,
  status    VARCHAR2(20) DEFAULT 'PENDING'
);

INSERT INTO orders (id, amount) VALUES (1001, 12000);
INSERT INTO orders (id, amount) VALUES (1002,  8000);
COMMIT;
```

위와 같은 스키마가 존재할 때, 값을 반환하는 함수를 확인해보겠습니다.

<br/>

- **함수(Function): 값을 반환**

```sql
-- 금액에 10% 세금을 적용해 합계를 >>값으로<< 돌려주는 함수
CREATE OR REPLACE FUNCTION apply_tax(p_amount NUMBER)
  RETURN NUMBER
AS
BEGIN
  RETURN ROUND(p_amount * 1.10, 2);
END;
/

-- 사용 예: SELECT의 표현식 자리에서 함수 호출
SELECT
  id,
  amount,
  apply_tax(amount) AS total_with_tax
FROM orders;
```

함수는 `RETURN` 으로 값을 돌려주며, `SELECT`, `WHERE`, `ORDER BY` 같은 **표현식** 자리에 끼워 넣을 수 있습니다.

<br/>

- **프로시저(Procedure): 명령으로 호출**

```sql
-- 주문을 결제완료로 바꾸는 프로시저 (DML 수행)
CREATE OR REPLACE PROCEDURE mark_paid(p_order_id IN orders.id%TYPE)
AS
BEGIN
  UPDATE orders
     SET status = 'PAID'
   WHERE id = p_order_id;

  COMMIT;
END;
/

-- 호출 예: EXEC(=CALL)로 직접 실행
EXEC mark_paid(1001);
```

프로시저는 값을 직접 반환하지 않지만 DML을 수행하고 트랜잭션을 관리하기 좋습니다.

또한 `SELECT ...` 같은 표현식 안에 넣어 쓸 수 없고, `EXEC`처럼 명령 형태로 호출합니다.

<br/>

- **OUT 파라미터를 통한 값 전달**

프로시저도 `OUT`/`IN OUT` 파라미터로 값을 “내보낼” 수 있습니다.

하지만 문법적으로는 여전히 프로시저이며, `SELECT` 표현식에서 바로 쓰진 못합니다.

<br/>
<br/>

> 참고
>
> - https://skylarcoding.tistory.com/191
> - https://seohee-ha.tistory.com/125
