# SQL Injection

SQL 인젝션은 응용 프로그램의 보안 취약점을 의도적으로 이용해 악의적인 SQL문을 실행시켜 데이터베이스를 비정상적으로 조작하는 코드 인젝션 공격 방법입니다.

다음은 사용자 로그인 검증을 위한 프로그램 예시입니다.

```sql
"SELECT Count(*) FROM Users WHERE Username=' "
+ txt.User.Text+" ' AND Password=' "+ txt.Password.Text+" ' ";
```

이 코드는 사용자가 입력한 아이디와 비밀번호가 일치하는 레코드를 찾습니다.

하지만 공격자가 유저네임에 `admin`, 패스워드에 `password' OR 1=1 --`을 입력하면 쿼리문은 다음과 같이 변형됩니다.

```sql
SELECT COUNT(*) FROM Users
WHERE Username='admin' AND Password='' OR 1=1 -- ';
```

`1=1`은 항상 참이므로 이 방법으로 공격자는 비밀번호 없이도 로그인할 수 있게 됩니다.

<br/>

## Blind SQL Injection

Blind SQL Injection은 참(True)과 거짓(False) 쿼리문 입력 시 서버의 응답 차이를 이용하여 데이터를 추출하는 공격입니다.

이 방식은 다른 SQL Injection과 달리 추출하려는 실제 데이터가 화면에 직접 표시되지 않습니다.

따라서 참 또는 거짓의 입력값에 따른 서버 응답을 통해 값을 간접적으로 유추해야 합니다.

<br/>

### 공격 진행 과정

1. 취약점 존재 여부 확인
   사용자 입력값을 결과로 출력하는 기능에서 SQL Injection 취약점 존재 여부를 확인한다. SQL구문에서 문법적 요소로 작용하는 싱글쿼터(') 같은 특수문자를 입력했을 때 서버의 반응을 보고 취약점 존재 여부를 판단할 수 있다.

2. Blind SQL Injection
   Blind SQL Injection은 참과 거짓의 논리를 통해 공격이 진행된다. 각 테이블/컬럼/데이터의 전체 개수를 확인하고 SUBSTR 함수로 각 테이블/컬럼/데이터의 문자를 하나씩 추출한다. 추출한 문자를 ASCII 함수를 사용해 숫자로 변환한 후 비교 연산으로 문자를 확인한다. 행 번호와 자릿수를 증가시키며 문자열 추적 과정을 반복하면 원하는 데이터를 추출할 수 있다.

<br/>

## **SQL 인젝션 공격의 영향**

성공적인 SQL 인젝션 공격은 다음과 같은 민감한 데이터에 무단 접근을 초래할 수 있습니다:

- 비밀번호
- 신용카드 정보
- 개인 사용자 정보

SQL 인젝션 공격은 수년간 많은 유명 데이터 유출 사건의 원인이 되었습니다.

공격자는 조직 시스템에 지속적인 백도어를 확보해 장기간 발견되지 않은 채로 남아있을 수 있어 장기적인 침해로 이어질 수 있습니다.

<br/>

## **SQL 인젝션 취약점 탐지 방법**

애플리케이션의 모든 진입점에 체계적인 테스트를 사용하여 SQL 인젝션을 수동으로 탐지할 수 있습니다.

일반적으로 다음과 같은 방법을 사용합니다:

- 작은따옴표(`'`)를 제출하고 오류나 이상 징후를 확인합니다.
- 진입점의 원래 값과 다르게 평가되는 SQL 구문을 제출하고, 응답의 체계적인 차이를 찾습니다.
- `OR 1=1`과 `OR 1=2`와 같은 불리언 조건을 제출하고, 응답 차이를 확인합니다.
- 시간 지연을 유발하는 페이로드를 제출하고, 응답 시간의 차이를 확인합니다.
- 대역 외 네트워크 상호작용을 유발하는 OAST 페이로드를 제출하고, 발생하는 상호작용을 모니터링합니다.

또는 Burp Scanner를 사용하면 대부분의 SQL 인젝션 취약점을 빠르고 안정적으로 찾을 수 있습니다.

<br/>

## **다양한 쿼리 부분에서의 SQL 인젝션**

대부분의 SQL 인젝션 취약점은 `SELECT` 쿼리의 `WHERE` 절에서 발생합니다. 대부분의 경험 있는 테스터들은 이러한 유형의 SQL 인젝션에 익숙합니다.

그러나 SQL 인젝션 취약점은 쿼리 내 어느 위치에서든, 다양한 쿼리 유형에서 발생할 수 있습니다.

SQL 인젝션이 발생하는 기타 일반적인 위치는 다음과 같습니다:

- `UPDATE` 문에서, 업데이트된 값이나 `WHERE` 절 내에서
- `INSERT` 문에서, 삽입된 값 내에서
- `SELECT` 문에서, 테이블이나 컬럼 이름 내에서
- `SELECT` 문에서, `ORDER BY` 절 내에서

<br/>

## 예방 방법

- 파라미터 바인딩을 기본으로 사용하고, 문자열 연결로 쿼리를 생성하지 않는다.
- 바인딩이 어려운 요소는 화이트리스트로 매핑하여 제한한다.
- 형식·길이·범위·문자셋에 대한 입력 검증을 서버에서 수행한다.
- 오류 메시지는 사용자에게 구체적으로 노출하지 않고 내부에만 기록한다.
- 애플리케이션의 DB 계정 권한을 최소화하고, 필요시 읽기/쓰기 권한을 분리한다.
- 저장 프로시저/함수 내부에서도 동적 SQL 남용을 금지한다.

<br/>
<br/>

> 참고
>
> - https://share.google/skxWwpfzD4WAmlVGN
> - https://ko.wikipedia.org/wiki/SQL_%EC%82%BD%EC%9E%85
