# DB 프로시저

우선 프로시저란 일련의 입력과 출력을 가지는 함수입니다. 이러한 프로시저는 데이터베이스에서도 존재합니다.
데이터베이스에서의 프로시저의 의미는 비슷합니다. 그 뜻은 아래와 같습니다.

> DB 프로시저(Stored Procedure)는 데이터베이스에 저장되어, 특정 작업을 반복적으로 실행할 수 있게 해주는 SQL 코드 집합이다.
> 하나의 프로시저로 여러 SQL문을 묶어 복잡한 비즈니스 로직을 효율적으로 처리할 수 있고, 코드 재사용성 및 성능 최적화에 도움이 된다.

예를 들어서 SELECT 문을 실행한 뒤에 해당 결과에 따라서 `INSERT, UPDATE`문을 실행할지 경정하는 코드도 프로시저가 될 수 있습니다.

아래의 코드 예시를 통해서 살펴봅시다.

### MySQL - 입출금 이체 프로시저 (트랜잭션 + 예외처리)

```mysql
-- 스키마 예시
-- accounts(id BIGINT PK, balance DECIMAL(15,2) NOT NULL)

DELIMITER $$

CREATE PROCEDURE sp_transfer_funds(
    IN p_from BIGINT,
    IN p_to   BIGINT,
    IN p_amount DECIMAL(15,2)
)
BEGIN
    DECLARE exit handler FOR SQLEXCEPTION
    BEGIN
        ROLLBACK;
        SIGNAL SQLSTATE '45000'
            SET MESSAGE_TEXT = 'Transfer failed. Rolled back.';
    END;

    IF p_amount <= 0 THEN
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Amount must be positive.';
    END IF;

    START TRANSACTION;

    -- 출금: 잔액 체크 + 차감
    UPDATE accounts
       SET balance = balance - p_amount
     WHERE id = p_from
       AND balance >= p_amount;

    IF ROW_COUNT() = 0 THEN
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Insufficient funds or invalid source account.';
    END IF;

    -- 입금
    UPDATE accounts
       SET balance = balance + p_amount
     WHERE id = p_to;

    IF ROW_COUNT() = 0 THEN
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Invalid destination account.';
    END IF;

    COMMIT;
END$$

DELIMITER ;
```

위의 예시를 통해서 아래를 유추해볼 수 있습니다.

- 프로시저는 SQL 명령문의 집합이다.
- 함수처럼 사용할 수 있으며, 여러 번 호출이 가능해 코드의 재사용성과 유지보수성이 뛰어나다.
- 일반적으로 INSERT, UPDATE, DELETE, SELECT 등 DML 작업을 묶어 처리할때 활용한다.

## 프로시저의 특징

1. 프로시저의를 하나의 메서드 형식처럼 만들고, API 처럼 이를 호출해서 프로시저 내부의 동작을 일괄적으로 처리합니다.
2. 하나의 요청으로 여러 SQL문을 실행 할 수 있기 때문에 네트워크 부하를 줄일 수 있습니다.

## 프로서저의 반환 값

프로시저는 일반적으로 입력 값을 받아들여 처리하고, 결과를 반환할 수 있습니다.
전통적인 의미의 프로시저는 반환 값이 없는 서브루틴을 지칭하는 데 사용되는 경우가 많았습니다.
하짐나 현대의 프로그래밍 언어나 DBMS 에서는 결과를 반환 할 수 있습니다.
프로그래밍 언어에 따라서 반환 값을 가지는 프로시저는 종종 함수라고 불리기도 합니다.

즉, 기본적으로 프로시저는 함수처럼 반환 값을 가질 수 없습니다.
하지만 OracleDB 같은 경우에는 OUT 변수를 사용해 결과를 반환하는 것처럼 보이게 할 수 있습니다.

정리하여 아래와 같은 장단점 및 기본 문법에 대해서 살펴보겠습니다.

## 프로시저의 장점

- 네트워크 부하 감소
- 비즈니스 로직 캡슐화
- 코드 재사용 및 관리

## 프로시저의 단점

- 문자, 숫자 연산이 많은 경우에는 일반 프로그래밍 언어보다 느릴 수 있다.
- 명령어 사용 추적이 어려워 유지보수성이 떨어진다.
- DBMS 마다 문법이 달라서 이식성이 떨어진다.

## 프로시저 기본 문법

### Oracle

```oracle
CREATE OR REPLACE PROCEDURE 프로시저명 (파라미터들)
IS
    -- 변수 선언
BEGIN
    -- 실행할 SQL 쿼리
END 프로시저명;

```

### MySQL

```mysql
DELIMITER $$
CREATE PROCEDURE 프로시저명 (파라미터들)
BEGIN
    -- SQL 쿼리 구문들
END $$
DELIMITER ;
```

## Reference 

https://skylarcoding.tistory.com/191