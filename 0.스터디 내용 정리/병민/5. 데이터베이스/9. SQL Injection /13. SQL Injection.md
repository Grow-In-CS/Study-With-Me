# SQL Injection

`SQL Injection`이란 한 종류의 웹 데이터베이스 공격 기법입니다.

사용자가 입력한 문자열이 쿼리 문자열에 그대로 붙어져 사용될 때 DB가 의도치 않는 SQL문을 실행하게 되는 취약점입니다.

- 원인: PreparedStatement의 바인딩 대신 동적 문자열 조립을 함
- 결과: 인증 우회, 임의 데이터 조회/수정/삭제, 스키마 유출, 데이터 덤프 등

## 공격 패턴

- 인증 우회: `id=admin' --`을 입력해 `WHERE id='admin' -- ' AND pw='...'` 뒤의 비밀번호 인증을 주석화 하는 것입니다. 
- 항상 참: `id=' OR '1'='1` 명령어로 필터를 무력화 합니다.
- 데이터 유출: `q=' UNION SELECT username, password FROM users --` 명령어로 모든 유저 데이터를 출력합니다.
- 블라인드 / 지연 기반: `id=1' OR SLEEP(5) --` 명령어로 db 커넥션 풀을 점유해 전체 서비스를 마비시킵니다.
- 스택드 쿼리(멀티 쿼리): `1'; DROP TABLE users; --` 명령어로 새로운 명령어를 실행합니다.

## Spring 환경에서 취약점 예시

### JdbcTemplate에 문자열을 직접 더함 

```java
String sql = "SELECT * FROM users WHERE email = '" + email + "' AND pw = '" + pw + "'";
return jdbcTemplate.queryForObject(sql, rowMapper);
```

### 바인딩을 통해 안전한 방법

```java
String sql = "SELECT * FROM users WHERE email = ? AND pw = ?";
return jdbcTemplate.queryForObject(sql, rowMapper, email, pw);
```

### 안전한 name parameter 사용법

```java
@Query(value = "SELECT * FROM users u WHERE u.email = :email", nativeQuery = true)
User findSafe(@Param("email") String email);
```

### 안전한 JPQL 사용법

```java
@Query("select u from User u where u.email = :email")
User findByEmail(@Param("email") String email);
```

즉 ORM을 사용한다고 해도 항상 안전한 것이 아닙니다.
JPQL 메서드, 쿼리/바인딩은 안전하지만, 네이티브 + 문자열 결합하여 사용하는 방법은 매우 위험합니다.

[유튜브 코딩애플 - SQL injection 공격 (6분)](https://www.youtube.com/watch?v=FoZ2cucLiDs)