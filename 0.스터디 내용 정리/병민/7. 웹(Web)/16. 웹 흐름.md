# 웹 흐름

이 문서는 브라우저 주소창에 `www.example.com` 을 입력했을 때 네트워크와 인프라를 따라가는 전체적인 흐름을 간단명료하게 정리한 문서입니다. (브라우저 내부 동작은 이미 다루었으므로 핵심 네트워크/인프라 위주로 서술합니다.)

## 요약 단계
1. 브라우저 (간단)
2. 로컬 네트워크 라우터
3. 라우팅(인터넷 경로)
4. DNS 해석
5. CDN(엣지)
6. 로드밸런서 (예: Nginx)
7. 서버 계층 (웹서버, WAS)
8. (옵션) Kubernetes 흐름

---

## 1. 브라우저
- URL 파싱: 스킴(https), 호스트(`www.example.com`), 경로 분해.
- 캐시/쿠키 검사: 브라우저나 OS에 캐시가 있으면 우선 검사.
- DNS 조회 필요 시 시스템에 DNS 요청을 보냄.
- HTTPS일 경우 TCP 연결 → TLS 핸드셰이크 → HTTP 요청 전송.

## 2. 로컬 네트워크 라우터
- 사용자의 기기는 로컬 라우터(가정/회사 게이트웨이)를 통해 외부로 나감.
- NAT를 통해 사설 IP를 공인 IP로 변환.
- 로컬 방화벽/포트포워딩 규칙이 적용될 수 있음.

## 3. 라우팅 (인터넷 경로)
- ISP(인터넷 서비스 제공자) 및 여러 라우터를 거쳐 목적지 쪽 네트워크로 패킷이 전달됨.
- 라우팅 테이블에 따라 최적 경로 선택.
- 중간 경로에서 패킷 손실/지연이 발생하면 TCP 재전송/지연 발생.

![Routing](https://velog.velcdn.com/images%2Fpilyeooong%2Fpost%2F24e5bd7f-412d-46ac-a9a4-e48e77105edf%2FScreen_Shot_2020-12-03_at_10.27.16_AM.png)

## 4. DNS 해석
- 브라우저/OS 캐시 → `hosts` 파일 → 로컬 DNS 리졸버 → 재귀적 DNS 서버 → 권한 있는 네임서버 순으로 A/AAAA 혹은 CNAME을 찾음.
- CNAME 체인이 더 있다면 최종 A 레코드로 매핑.
- TTL에 따라 캐시 유지 기간 결정.
- DNS 응답으로 얻은 IP가 CDN 엣지 또는 원본 서버 IP일 수 있음.

## 5. CDN (엣지)
- 사용자가 가까운 POP(edge)으로 라우팅되어 빠른 응답 제공.
- CDN 캐시 히트: 엣지에서 바로 응답(정적 자원, 이미지, 빌드된 JS/CSS 등).
- CDN 캐시 미스: 엣지가 오리진(원본)으로 요청을 전달해 받아오고 이후 캐시.
- CDN은 TLS 종료, 압축, HTTP/2, 캐싱 정책, 캐시 무효화 기능을 제공.

## 6. 로드밸런서 (예: Nginx)
- CDN을 거치지 않거나 오리진으로 요청이 온 경우, 로드밸런서가 요청을 여러 백엔드로 분배.
- 역할: SSL 종료(또는 패스스루), 리버스 프록시, 라우팅, 세션 스티키, 헬스체크, gzip/brotli, 정적 캐시.
- 로드밸런싱 전략: Round Robin, Least Conn, IP Hash 등.
- 요청 헤더 보존: `X-Forwarded-For`, `X-Forwarded-Proto`, `Host` 등 전달.

## 7. 서버 계층 (웹서버, WAS)
- 웹서버(Nginx/Apache)
	- 정적 파일(이미지, JS/CSS) 직접 서빙.
	- 동적 요청은 WAS로 프록시 패스.
- WAS(Tomcat, Spring 등)
	- 애플리케이션 로직 실행, DB/캐시 호출, 세션 관리, 인증/인가 처리.
	- 응답 생성 후 웹서버/로드밸런서를 통해 클라이언트로 반환.
- 추가 요소: DB, Redis, 메시지 큐 등 후단 서비스와의 통신.
- 응답은 CDN 또는 클라이언트에게 전달되며, 적절한 캐시 제어 헤더가 포함됨.

## 8. (옵션) Kubernetes 사용 시 흐름
- 외부 로드밸런서(Cloud LB) → Ingress Controller(예: Nginx Ingress, Traefik)
- Ingress 리소스가 호스트/경로 기반 라우팅을 수행.
- Ingress → Service(ClusterIP) → kube-proxy → 해당 Node의 Pod(컨테이너)로 전달.
- Pod 내부에서 애플리케이션 컨테이너(WAS)가 처리하고, 필요한 경우 Sidecar(로깅/프록시)와 통신.
- 스케일링: HPA/Cluster Autoscaler로 자동 확장.
- 헬스체크: Readiness/Liveness probe로 트래픽 분배 및 재시작 규칙 적용.
- 서비스 디스커버리와 내부 DNS(Kube DNS)를 통해 마이크로서비스 간 호출이 이루어짐.

---

## 추가 포인트 (간단)
- TLS: 클라이언트가 TLS를 사용할 경우 대부분의 TLS 종료는 CDN 또는 LB에서 처리해 오리진은 내부 트래픽(HTTP)로 구성 가능.
- 성능 최적화: CDN 사용, HTTP/2/3, Keep-Alive, 압축, 캐싱 헤더, 파일 fingerprinting 권장.
- 장애 대응: Health checks, 리트라이, 서킷 브레이커, 로깅/모니터링 필요.
- 보안: WAF, Rate limiting, 인증/인가, CORS, SameSite/HttpOnly 쿠키 설정 고려.

---

## 한줄 요약
브라우저 → 로컬 라우터 → 인터넷 라우팅 → DNS 해석 → (CDN 엣지) → LB(Nginx) → 웹서버/ WAS → 백엔드(DB/캐시) → 응답. (k8s 환경이면 Ingress → Service → Pod 경로가 중간에 위치)
